import { request } from '../../utils/request/index';
import { API } from "../../config/cgi-config";
import { orderStatus } from "../../utils/request/common";
const app = getApp();
let payState;
Page({
    data: {
        loading: 1,
        currentTab: 0,
        list: [],
        swiperHeight: '',
        normalUrl: '',
        isHasData: false,
        orderMsg: ''
    },
    loadMsg(type) {
        wx.showLoading({
            title: '加载中'
        });
        let _this = this;
        if (type === 0) {
            payState = 1;
        }
        else if (type === 1) {
            payState = 0;
        }
        else {
            payState = 2;
        }
        const data = {
            id: app.globalData.userInfo.id,
            type: payState,
            page: 1,
            limit: 10,
        };
        request({
            url: API.getOrder,
            data: data,
        }).then((res) => {
            wx.hideLoading();
            if (res.data.course.length === 0) {
                _this.setData({
                    loading: 0
                });
            }
            else {
                _this.setData({
                    list: res.data.course,
                    loading: 2
                });
                let query = wx.createSelectorQuery();
                query.select('#list' + _this.data.currentTab).boundingClientRect(() => { });
                query.selectViewport().scrollOffset(() => { });
                query.exec(function (res) {
                    _this.setData({
                        swiperHeight: (res[0].height + 20) * _this.data.list.length
                    });
                });
            }
        });
    },
    go_index() {
        if (this.data.currentTab == 0) {
            wx.switchTab({
                url: '../index/index'
            });
        }
    },
    cancelPay(e) {
        let id = e.target.dataset.id;
        let _this = this;
        request({
            url: API.cancelOrder,
            data: { id }
        }).then((res) => {
            if (res.data.success) {
                wx.showToast({
                    title: '取消成功',
                    icon: 'success',
                    duration: 2000
                });
                _this.loadMsg(_this.data.currentTab);
            }
        }).catch(() => {
            wx.showToast({
                title: '取消失败',
                duration: 2000
            });
        });
    },
    deleteOrder(e) {
        let id = e.target.dataset.id;
        let _this = this;
        request({
            url: API.deleteOrder,
            data: { id }
        }).then((res) => {
            if (res.data.success) {
                wx.showToast({
                    title: '删除成功',
                    icon: 'success',
                    duration: 2000
                });
                _this.loadMsg(_this.data.currentTab);
            }
        }).catch(() => {
            wx.showToast({
                title: '删除失败',
                duration: 2000
            });
        });
    },
    paymentOrder(e) {
        let _this = this;
        wx.showLoading({
            title: '请稍等...',
        });
        const { courseid, outtradeno, noncestr, title, price } = e.target.dataset;
        if (app.globalData.userInfo && app.globalData.userInfo.token && app.globalData.userInfo.id && courseid) {
            orderStatus(app.globalData.userInfo.id, courseid).then((response) => {
                if (response.data.success) {
                    if (response.data.isPay == 0) {
                        request({
                            url: API.getPayMsg,
                            data: {
                                openId: app.globalData.userInfo.openId,
                                id: app.globalData.userInfo.id,
                                courseId: courseid,
                                desc: '学程教育-课程支付',
                                totalPrice: price,
                                notify_url: API.NotifyUrl,
                                isOrderPay: 1,
                                merchOrderId: outtradeno,
                                nonceStr: noncestr,
                            }
                        }).then((res) => {
                            wx.hideLoading({});
                            if (res.data.success) {
                                wx.requestPayment({
                                    timeStamp: res.data.res.timeStamp,
                                    nonceStr: res.data.res.nonceStr,
                                    package: res.data.res.package,
                                    signType: res.data.res.signType,
                                    paySign: res.data.res.paySign,
                                    success: function (resPay) {
                                        if (resPay.errMsg === 'requestPayment:ok') {
                                            _this.loadMsg(_this.data.currentTab);
                                            wx.showToast({
                                                title: '支付成功',
                                                icon: "none",
                                                duration: 2000
                                            });
                                            _this.requestPay(res.data.prepayId, res.data.outTradeNo, title, price, courseid);
                                        }
                                    },
                                    fail() {
                                        wx.showToast({
                                            title: '支付失败',
                                            icon: "none",
                                            duration: 2000
                                        });
                                    },
                                });
                            }
                        }).catch((err) => {
                            wx.hideLoading({});
                            console.log(err);
                        });
                    }
                    else {
                        wx.showToast({
                            title: '您已购买过该课程了哦~',
                            icon: "none",
                            duration: 2000
                        });
                    }
                }
            });
        }
        else {
        }
    },
    onLoad() {
        this.loadMsg(this.data.currentTab);
        this.setData({
            normalUrl: API.normalUrl
        });
    },
    swiperTab: function (e) {
        let _this = this;
        _this.setData({
            currentTab: e.detail.current
        });
        _this.loadMsg(this.data.currentTab);
    },
    clickTab(e) {
        let _this = this;
        if (_this.data.currentTab === e.target.dataset.current)
            return false;
        _this.setData({
            loading: 1,
            list: [],
        });
        this.loadMsg(parseInt(e.target.dataset.current));
        _this.setData({
            currentTab: e.target.dataset.current
        });
    },
    requestPay(prepayId, outTradeNo, title, price, courseid) {
        request({
            url: API.sendTemplate,
            data: {
                userId: app.globalData.userInfo.id,
                prepayId: prepayId,
                outTradeNo: outTradeNo,
                courseName: title,
                price: price,
                courseId: courseid,
            }
        }).then((res) => {
            console.log(res);
        });
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXlPcmRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm15T3JkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLDJCQUEyQixDQUFBO0FBQ25ELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM5QyxPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sNEJBQTRCLENBQUM7QUFFdkQsTUFBTSxHQUFHLEdBQUcsTUFBTSxFQUFVLENBQUE7QUFDNUIsSUFBSSxRQUFnQixDQUFBO0FBRXBCLElBQUksQ0FBQztJQUNILElBQUksRUFBRTtRQUNKLE9BQU8sRUFBRSxDQUFDO1FBQ1YsVUFBVSxFQUFDLENBQUM7UUFDWixJQUFJLEVBQUMsRUFBRTtRQUNQLFlBQVksRUFBQyxFQUFFO1FBQ2YsU0FBUyxFQUFFLEVBQUU7UUFDYixTQUFTLEVBQUUsS0FBSztRQUNoQixRQUFRLEVBQUcsRUFBRTtLQUNkO0lBQ0QsT0FBTyxDQUFDLElBQVk7UUFDbEIsRUFBRSxDQUFDLFdBQVcsQ0FBQztZQUNiLEtBQUssRUFBRSxLQUFLO1NBQ2IsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFBO1FBQ2hCLElBQUcsSUFBSSxLQUFLLENBQUMsRUFBRTtZQUNiLFFBQVEsR0FBRyxDQUFDLENBQUE7U0FDYjthQUFLLElBQUcsSUFBSSxLQUFLLENBQUMsRUFBQztZQUNsQixRQUFRLEdBQUcsQ0FBQyxDQUFBO1NBQ2I7YUFBTTtZQUNMLFFBQVEsR0FBRyxDQUFDLENBQUE7U0FDYjtRQUNELE1BQU0sSUFBSSxHQUFHO1lBQ1QsRUFBRSxFQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDN0IsSUFBSSxFQUFDLFFBQVE7WUFDYixJQUFJLEVBQUUsQ0FBQztZQUNQLEtBQUssRUFBRSxFQUFFO1NBQ1osQ0FBQTtRQUNELE9BQU8sQ0FBQztZQUNOLEdBQUcsRUFBQyxHQUFHLENBQUMsUUFBUTtZQUNoQixJQUFJLEVBQUMsSUFBSTtTQUNWLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFRLEVBQUMsRUFBRTtZQUNsQixFQUFFLENBQUMsV0FBVyxFQUFFLENBQUE7WUFDaEIsSUFBRyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUMvQixLQUFLLENBQUMsT0FBUSxDQUFDO29CQUNiLE9BQU8sRUFBQyxDQUFDO2lCQUNWLENBQUMsQ0FBQTthQUNIO2lCQUFJO2dCQUNILEtBQUssQ0FBQyxPQUFRLENBQUM7b0JBQ2IsSUFBSSxFQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTTtvQkFFcEIsT0FBTyxFQUFDLENBQUM7aUJBQ1YsQ0FBQyxDQUFBO2dCQUNGLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxDQUFBO2dCQUNwQyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLEdBQUUsRUFBRSxHQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUN4RSxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUMsWUFBWSxDQUFDLEdBQUUsRUFBRSxHQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUMzQyxLQUFLLENBQUMsSUFBSSxDQUFDLFVBQVUsR0FBUztvQkFDMUIsS0FBSyxDQUFDLE9BQVEsQ0FBQzt3QkFDYixZQUFZLEVBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQyxHQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU07cUJBQzNELENBQUMsQ0FBQTtnQkFDTixDQUFDLENBQUMsQ0FBQTthQUNIO1FBQ0gsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0lBRUQsUUFBUTtRQUNOLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxFQUFFO1lBQzdCLEVBQUUsQ0FBQyxTQUFTLENBQUM7Z0JBQ1gsR0FBRyxFQUFFLGdCQUFnQjthQUN0QixDQUFDLENBQUE7U0FDSDtJQUNILENBQUM7SUFFRCxTQUFTLENBQUUsQ0FBTztRQUNoQixJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUE7UUFDNUIsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFBO1FBQ2hCLE9BQU8sQ0FBQztZQUNKLEdBQUcsRUFBRyxHQUFHLENBQUMsV0FBVztZQUNyQixJQUFJLEVBQUcsRUFBRSxFQUFFLEVBQUU7U0FDaEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQVEsRUFBQyxFQUFFO1lBQ2xCLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUU7Z0JBQ3BCLEVBQUUsQ0FBQyxTQUFTLENBQUM7b0JBQ1gsS0FBSyxFQUFFLE1BQU07b0JBQ2IsSUFBSSxFQUFFLFNBQVM7b0JBQ2YsUUFBUSxFQUFFLElBQUk7aUJBQ2YsQ0FBQyxDQUFBO2dCQUNGLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQTthQUNyQztRQUNILENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFFLEVBQUU7WUFDWCxFQUFFLENBQUMsU0FBUyxDQUFDO2dCQUNYLEtBQUssRUFBRSxNQUFNO2dCQUNiLFFBQVEsRUFBRSxJQUFJO2FBQ2YsQ0FBQyxDQUFBO1FBQ0osQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0lBRUQsV0FBVyxDQUFFLENBQU87UUFDbEIsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFBO1FBQzVCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQTtRQUNoQixPQUFPLENBQUM7WUFDSixHQUFHLEVBQUcsR0FBRyxDQUFDLFdBQVc7WUFDckIsSUFBSSxFQUFHLEVBQUMsRUFBRSxFQUFDO1NBQ2QsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQVEsRUFBQyxFQUFFO1lBQ2hCLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUU7Z0JBQ3BCLEVBQUUsQ0FBQyxTQUFTLENBQUM7b0JBQ1gsS0FBSyxFQUFFLE1BQU07b0JBQ2IsSUFBSSxFQUFFLFNBQVM7b0JBQ2YsUUFBUSxFQUFFLElBQUk7aUJBQ2YsQ0FBQyxDQUFBO2dCQUNGLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQTthQUNyQztRQUNMLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFFLEVBQUU7WUFDWCxFQUFFLENBQUMsU0FBUyxDQUFDO2dCQUNYLEtBQUssRUFBRSxNQUFNO2dCQUNiLFFBQVEsRUFBRSxJQUFJO2FBQ2YsQ0FBQyxDQUFBO1FBQ0osQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0lBRUQsWUFBWSxDQUFFLENBQU87UUFDbkIsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFBO1FBQ2hCLEVBQUUsQ0FBQyxXQUFXLENBQUM7WUFDYixLQUFLLEVBQUUsUUFBUTtTQUNoQixDQUFDLENBQUE7UUFDRixNQUFNLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFBO1FBQ3pFLElBQUksR0FBRyxDQUFDLFVBQVUsQ0FBQyxRQUFRLElBQUksR0FBRyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsS0FBSyxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUUsSUFBSSxRQUFRLEVBQUM7WUFDbkcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUUsRUFBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFjLEVBQUUsRUFBRTtnQkFDdkUsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRTtvQkFDekIsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLEVBQUU7d0JBQzVCLE9BQU8sQ0FBQzs0QkFDTixHQUFHLEVBQUUsR0FBRyxDQUFDLFNBQVM7NEJBQ2xCLElBQUksRUFBRTtnQ0FDSixNQUFNLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsTUFBTTtnQ0FDdEMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0NBQzlCLFFBQVEsRUFBRSxRQUFRO2dDQUNsQixJQUFJLEVBQUUsV0FBVztnQ0FDakIsVUFBVSxFQUFFLEtBQUs7Z0NBQ2pCLFVBQVUsRUFBRSxHQUFHLENBQUMsU0FBUztnQ0FDekIsVUFBVSxFQUFFLENBQUM7Z0NBQ2IsWUFBWSxFQUFFLFVBQVU7Z0NBQ3hCLFFBQVEsRUFBQyxRQUFROzZCQUNsQjt5QkFDRixDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBUSxFQUFDLEVBQUU7NEJBQ2xCLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUE7NEJBQ2xCLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUU7Z0NBQ3BCLEVBQUUsQ0FBQyxjQUFjLENBQUM7b0NBQ2hCLFNBQVMsRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTO29DQUNqQyxRQUFRLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUTtvQ0FDL0IsT0FBTyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU87b0NBQzdCLFFBQVEsRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRO29DQUMvQixPQUFPLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTztvQ0FDN0IsT0FBTyxFQUFHLFVBQVMsTUFBVzt3Q0FDNUIsSUFBRyxNQUFNLENBQUMsTUFBTSxLQUFLLG1CQUFtQixFQUFDOzRDQUN2QyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUE7NENBQ3BDLEVBQUUsQ0FBQyxTQUFTLENBQUM7Z0RBQ1gsS0FBSyxFQUFFLE1BQU07Z0RBQ2IsSUFBSSxFQUFHLE1BQU07Z0RBQ2IsUUFBUSxFQUFFLElBQUk7NkNBQ2YsQ0FBQyxDQUFBOzRDQUNGLEtBQUssQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxRQUFRLENBQUMsQ0FBQTt5Q0FDN0U7b0NBQ0gsQ0FBQztvQ0FDRCxJQUFJO3dDQUNGLEVBQUUsQ0FBQyxTQUFTLENBQUM7NENBQ1gsS0FBSyxFQUFFLE1BQU07NENBQ2IsSUFBSSxFQUFHLE1BQU07NENBQ2IsUUFBUSxFQUFFLElBQUk7eUNBQ2YsQ0FBQyxDQUFBO29DQUNKLENBQUM7aUNBQ0YsQ0FBQyxDQUFBOzZCQUNIO3dCQUNILENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQVEsRUFBQyxFQUFFOzRCQUNuQixFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFBOzRCQUNsQixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFBO3dCQUNsQixDQUFDLENBQUMsQ0FBQTtxQkFDSDt5QkFBTTt3QkFDTCxFQUFFLENBQUMsU0FBUyxDQUFDOzRCQUNYLEtBQUssRUFBRSxhQUFhOzRCQUNwQixJQUFJLEVBQUcsTUFBTTs0QkFDYixRQUFRLEVBQUUsSUFBSTt5QkFDZixDQUFDLENBQUE7cUJBQ0g7aUJBQ0Y7WUFDSCxDQUFDLENBQUMsQ0FBQTtTQUNMO2FBQUs7U0FDTDtJQUNILENBQUM7SUFDRCxNQUFNO1FBQ0osSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFBO1FBQ2xDLElBQUksQ0FBQyxPQUFRLENBQUM7WUFDWixTQUFTLEVBQUUsR0FBRyxDQUFDLFdBQVc7U0FDM0IsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVELFNBQVMsRUFBQyxVQUFVLENBQU07UUFDeEIsSUFBSSxLQUFLLEdBQUMsSUFBSSxDQUFDO1FBQ2YsS0FBSyxDQUFDLE9BQVEsQ0FBQztZQUNiLFVBQVUsRUFBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU87U0FDNUIsQ0FBQyxDQUFDO1FBQ0gsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFBO0lBQ3JDLENBQUM7SUFFRCxRQUFRLENBQUUsQ0FBTTtRQUNkLElBQUksS0FBSyxHQUFDLElBQUksQ0FBQztRQUNmLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTztZQUFHLE9BQU8sS0FBSyxDQUFBO1FBQ3JFLEtBQUssQ0FBQyxPQUFRLENBQUU7WUFDZCxPQUFPLEVBQUUsQ0FBQztZQUNWLElBQUksRUFBRSxFQUFFO1NBQ1QsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQTtRQUNoRCxLQUFLLENBQUMsT0FBUSxDQUFFO1lBQ2QsVUFBVSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU87U0FDckMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUNELFVBQVUsQ0FBQyxRQUFnQixFQUFDLFVBQWUsRUFBQyxLQUFhLEVBQUUsS0FBVSxFQUFFLFFBQWdCO1FBQ3JGLE9BQU8sQ0FBQztZQUNOLEdBQUcsRUFBRSxHQUFHLENBQUMsWUFBWTtZQUNyQixJQUFJLEVBQUU7Z0JBQ0osTUFBTSxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0JBQ2xDLFFBQVEsRUFBRSxRQUFRO2dCQUNsQixVQUFVLEVBQUUsVUFBVTtnQkFDdEIsVUFBVSxFQUFFLEtBQUs7Z0JBQ2pCLEtBQUssRUFBRSxLQUFLO2dCQUNaLFFBQVEsRUFBRSxRQUFRO2FBQ25CO1NBQ0YsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQVEsRUFBQyxFQUFFO1lBQ2xCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDbEIsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSU15QXBwIH0gZnJvbSAnLi4vLi4vYXBwJ1xuaW1wb3J0IHsgcmVxdWVzdCB9IGZyb20gJy4uLy4uL3V0aWxzL3JlcXVlc3QvaW5kZXgnXG5pbXBvcnQgeyBBUEkgfSBmcm9tIFwiLi4vLi4vY29uZmlnL2NnaS1jb25maWdcIjtcbmltcG9ydCB7b3JkZXJTdGF0dXN9IGZyb20gXCIuLi8uLi91dGlscy9yZXF1ZXN0L2NvbW1vblwiO1xuXG5jb25zdCBhcHAgPSBnZXRBcHA8SU15QXBwPigpXG5sZXQgcGF5U3RhdGU6IG51bWJlclxuXG5QYWdlKHtcbiAgZGF0YToge1xuICAgIGxvYWRpbmc6IDEsXG4gICAgY3VycmVudFRhYjowLFxuICAgIGxpc3Q6W10sXG4gICAgc3dpcGVySGVpZ2h0OicnLFxuICAgIG5vcm1hbFVybDogJycsXG4gICAgaXNIYXNEYXRhOiBmYWxzZSxcbiAgICBvcmRlck1zZyA6ICcnXG4gIH0sXG4gIGxvYWRNc2codHlwZTogbnVtYmVyKSB7XG4gICAgd3guc2hvd0xvYWRpbmcoe1xuICAgICAgdGl0bGU6ICfliqDovb3kuK0nXG4gICAgfSlcbiAgICBsZXQgX3RoaXMgPSB0aGlzXG4gICAgaWYodHlwZSA9PT0gMCkge1xuICAgICAgcGF5U3RhdGUgPSAxXG4gICAgfWVsc2UgaWYodHlwZSA9PT0gMSl7XG4gICAgICBwYXlTdGF0ZSA9IDBcbiAgICB9IGVsc2Uge1xuICAgICAgcGF5U3RhdGUgPSAyXG4gICAgfVxuICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICAgIGlkOmFwcC5nbG9iYWxEYXRhLnVzZXJJbmZvLmlkLFxuICAgICAgICB0eXBlOnBheVN0YXRlLFxuICAgICAgICBwYWdlOiAxLFxuICAgICAgICBsaW1pdDogMTAsXG4gICAgfVxuICAgIHJlcXVlc3Qoe1xuICAgICAgdXJsOkFQSS5nZXRPcmRlcixcbiAgICAgIGRhdGE6ZGF0YSxcbiAgICB9KS50aGVuKChyZXM6IGFueSk9PntcbiAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgIGlmKHJlcy5kYXRhLmNvdXJzZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgX3RoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgIGxvYWRpbmc6MFxuICAgICAgICB9KVxuICAgICAgfWVsc2V7XG4gICAgICAgIF90aGlzLnNldERhdGEhKHtcbiAgICAgICAgICBsaXN0OnJlcy5kYXRhLmNvdXJzZSxcbiAgICAgICAgICAvLyBzd2lwZXJIZWlnaHQ6IDE5MCpyZXMuZGF0YS5jb3Vyc2UubGVuZ3RoLFxuICAgICAgICAgIGxvYWRpbmc6MlxuICAgICAgICB9KVxuICAgICAgICBsZXQgcXVlcnkgPSB3eC5jcmVhdGVTZWxlY3RvclF1ZXJ5KClcbiAgICAgICAgcXVlcnkuc2VsZWN0KCcjbGlzdCcgKyBfdGhpcy5kYXRhLmN1cnJlbnRUYWIpLmJvdW5kaW5nQ2xpZW50UmVjdCgoKT0+e30pXG4gICAgICAgIHF1ZXJ5LnNlbGVjdFZpZXdwb3J0KCkuc2Nyb2xsT2Zmc2V0KCgpPT57fSlcbiAgICAgICAgcXVlcnkuZXhlYyhmdW5jdGlvbiAocmVzIDogYW55KSB7XG4gICAgICAgICAgICBfdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgICAgIHN3aXBlckhlaWdodCA6IChyZXNbMF0uaGVpZ2h0ICsgMjApKl90aGlzLmRhdGEubGlzdC5sZW5ndGhcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSlcbiAgfSxcbiAgLy/ngrnlh7vnvLrphpLlm77lm57liLDpppbpobVcbiAgZ29faW5kZXggKCkge1xuICAgIGlmICh0aGlzLmRhdGEuY3VycmVudFRhYiA9PSAwKSB7XG4gICAgICB3eC5zd2l0Y2hUYWIoe1xuICAgICAgICB1cmw6ICcuLi9pbmRleC9pbmRleCdcbiAgICAgIH0pXG4gICAgfVxuICB9LFxuICAvL+WPlua2iOaUr+S7mFxuICBjYW5jZWxQYXkgKGUgOiBhbnkpIHtcbiAgICBsZXQgaWQgPSBlLnRhcmdldC5kYXRhc2V0LmlkXG4gICAgbGV0IF90aGlzID0gdGhpc1xuICAgIHJlcXVlc3Qoe1xuICAgICAgICB1cmwgOiBBUEkuY2FuY2VsT3JkZXIsXG4gICAgICAgIGRhdGEgOiB7IGlkIH1cbiAgICB9KS50aGVuKChyZXM6IGFueSk9PntcbiAgICAgIGlmIChyZXMuZGF0YS5zdWNjZXNzKSB7XG4gICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgdGl0bGU6ICflj5bmtojmiJDlip8nLFxuICAgICAgICAgIGljb246ICdzdWNjZXNzJyxcbiAgICAgICAgICBkdXJhdGlvbjogMjAwMFxuICAgICAgICB9KVxuICAgICAgICBfdGhpcy5sb2FkTXNnKF90aGlzLmRhdGEuY3VycmVudFRhYilcbiAgICAgIH1cbiAgICB9KS5jYXRjaCgoKT0+e1xuICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgdGl0bGU6ICflj5bmtojlpLHotKUnLFxuICAgICAgICBkdXJhdGlvbjogMjAwMFxuICAgICAgfSlcbiAgICB9KVxuICB9LFxuICAvL+WIoOmZpOiuouWNlVxuICBkZWxldGVPcmRlciAoZSA6IGFueSkge1xuICAgIGxldCBpZCA9IGUudGFyZ2V0LmRhdGFzZXQuaWRcbiAgICBsZXQgX3RoaXMgPSB0aGlzXG4gICAgcmVxdWVzdCh7XG4gICAgICAgIHVybCA6IEFQSS5kZWxldGVPcmRlcixcbiAgICAgICAgZGF0YSA6IHtpZH1cbiAgICB9KS50aGVuKChyZXM6IGFueSk9PntcbiAgICAgICAgaWYgKHJlcy5kYXRhLnN1Y2Nlc3MpIHtcbiAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgdGl0bGU6ICfliKDpmaTmiJDlip8nLFxuICAgICAgICAgICAgaWNvbjogJ3N1Y2Nlc3MnLFxuICAgICAgICAgICAgZHVyYXRpb246IDIwMDBcbiAgICAgICAgICB9KVxuICAgICAgICAgIF90aGlzLmxvYWRNc2coX3RoaXMuZGF0YS5jdXJyZW50VGFiKVxuICAgICAgICB9XG4gICAgfSkuY2F0Y2goKCk9PntcbiAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgIHRpdGxlOiAn5Yig6Zmk5aSx6LSlJyxcbiAgICAgICAgZHVyYXRpb246IDIwMDBcbiAgICAgIH0pXG4gICAgfSlcbiAgfSxcbiAgLy/mlK/ku5jorqLljZVcbiAgcGF5bWVudE9yZGVyIChlIDogYW55KSB7XG4gICAgbGV0IF90aGlzID0gdGhpc1xuICAgIHd4LnNob3dMb2FkaW5nKHtcbiAgICAgIHRpdGxlOiAn6K+356iN562JLi4uJyxcbiAgICB9KVxuICAgIGNvbnN0IHsgY291cnNlaWQsIG91dHRyYWRlbm8sIG5vbmNlc3RyLCB0aXRsZSwgcHJpY2UgfSA9IGUudGFyZ2V0LmRhdGFzZXRcbiAgICBpZiAoYXBwLmdsb2JhbERhdGEudXNlckluZm8gJiYgYXBwLmdsb2JhbERhdGEudXNlckluZm8udG9rZW4gJiYgYXBwLmdsb2JhbERhdGEudXNlckluZm8uaWQgJiYgY291cnNlaWQpe1xuICAgICAgICBvcmRlclN0YXR1cyhhcHAuZ2xvYmFsRGF0YS51c2VySW5mby5pZCxjb3Vyc2VpZCkudGhlbigocmVzcG9uc2UgOiBhbnkpID0+IHtcbiAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5zdWNjZXNzKSB7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5pc1BheSA9PSAwKSB7XG4gICAgICAgICAgICAgIHJlcXVlc3Qoe1xuICAgICAgICAgICAgICAgIHVybDogQVBJLmdldFBheU1zZyxcbiAgICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgICBvcGVuSWQ6IGFwcC5nbG9iYWxEYXRhLnVzZXJJbmZvLm9wZW5JZCxcbiAgICAgICAgICAgICAgICAgIGlkOiBhcHAuZ2xvYmFsRGF0YS51c2VySW5mby5pZCxcbiAgICAgICAgICAgICAgICAgIGNvdXJzZUlkOiBjb3Vyc2VpZCxcbiAgICAgICAgICAgICAgICAgIGRlc2M6ICflrabnqIvmlZnogrIt6K++56iL5pSv5LuYJyxcbiAgICAgICAgICAgICAgICAgIHRvdGFsUHJpY2U6IHByaWNlLFxuICAgICAgICAgICAgICAgICAgbm90aWZ5X3VybDogQVBJLk5vdGlmeVVybCxcbiAgICAgICAgICAgICAgICAgIGlzT3JkZXJQYXk6IDEsXG4gICAgICAgICAgICAgICAgICBtZXJjaE9yZGVySWQ6IG91dHRyYWRlbm8sXG4gICAgICAgICAgICAgICAgICBub25jZVN0cjpub25jZXN0cixcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pLnRoZW4oKHJlczogYW55KT0+e1xuICAgICAgICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKHt9KVxuICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5zdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgICB3eC5yZXF1ZXN0UGF5bWVudCh7XG4gICAgICAgICAgICAgICAgICAgIHRpbWVTdGFtcDogcmVzLmRhdGEucmVzLnRpbWVTdGFtcCxcbiAgICAgICAgICAgICAgICAgICAgbm9uY2VTdHI6IHJlcy5kYXRhLnJlcy5ub25jZVN0cixcbiAgICAgICAgICAgICAgICAgICAgcGFja2FnZTogcmVzLmRhdGEucmVzLnBhY2thZ2UsXG4gICAgICAgICAgICAgICAgICAgIHNpZ25UeXBlOiByZXMuZGF0YS5yZXMuc2lnblR5cGUsXG4gICAgICAgICAgICAgICAgICAgIHBheVNpZ246IHJlcy5kYXRhLnJlcy5wYXlTaWduLFxuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzIDogZnVuY3Rpb24ocmVzUGF5OiBhbnkpIHtcbiAgICAgICAgICAgICAgICAgICAgICBpZihyZXNQYXkuZXJyTXNnID09PSAncmVxdWVzdFBheW1lbnQ6b2snKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmxvYWRNc2coX3RoaXMuZGF0YS5jdXJyZW50VGFiKVxuICAgICAgICAgICAgICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6ICfmlK/ku5jmiJDlip8nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBpY29uIDogXCJub25lXCIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAyMDAwXG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMucmVxdWVzdFBheShyZXMuZGF0YS5wcmVwYXlJZCxyZXMuZGF0YS5vdXRUcmFkZU5vLHRpdGxlLHByaWNlLGNvdXJzZWlkKVxuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgZmFpbCgpIHtcbiAgICAgICAgICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6ICfmlK/ku5jlpLHotKUnLFxuICAgICAgICAgICAgICAgICAgICAgICAgaWNvbiA6IFwibm9uZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDIwMDBcbiAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pLmNhdGNoKChlcnI6IGFueSk9PntcbiAgICAgICAgICAgICAgICB3eC5oaWRlTG9hZGluZyh7fSlcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgICAgIHRpdGxlOiAn5oKo5bey6LSt5Lmw6L+H6K+l6K++56iL5LqG5ZOmficsXG4gICAgICAgICAgICAgICAgaWNvbiA6IFwibm9uZVwiLFxuICAgICAgICAgICAgICAgIGR1cmF0aW9uOiAyMDAwXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH1lbHNlIHtcbiAgICB9XG4gIH0sXG4gIG9uTG9hZCgpIHtcbiAgICB0aGlzLmxvYWRNc2codGhpcy5kYXRhLmN1cnJlbnRUYWIpXG4gICAgdGhpcy5zZXREYXRhISh7XG4gICAgICBub3JtYWxVcmw6IEFQSS5SZXNvdXJzZVVybFxuICAgIH0pXG4gIH0sXG4gIC8v5ruR5Yqo5YiH5o2iXG4gIHN3aXBlclRhYjpmdW5jdGlvbiggZTogYW55ICl7XG4gICAgbGV0IF90aGlzPXRoaXM7XG4gICAgX3RoaXMuc2V0RGF0YSEoe1xuICAgICAgY3VycmVudFRhYjplLmRldGFpbC5jdXJyZW50XG4gICAgfSk7XG4gICAgX3RoaXMubG9hZE1zZyh0aGlzLmRhdGEuY3VycmVudFRhYilcbiAgfSxcbiAgLy/ngrnlh7vliIfmjaJcbiAgY2xpY2tUYWIoIGU6IGFueSApOiBhbnkge1xuICAgIGxldCBfdGhpcz10aGlzO1xuICAgIGlmKCBfdGhpcy5kYXRhLmN1cnJlbnRUYWIgPT09IGUudGFyZ2V0LmRhdGFzZXQuY3VycmVudCApIHJldHVybiBmYWxzZVxuICAgIF90aGlzLnNldERhdGEhKCB7XG4gICAgICBsb2FkaW5nOiAxLFxuICAgICAgbGlzdDogW10sXG4gICAgfSlcbiAgICB0aGlzLmxvYWRNc2cocGFyc2VJbnQoZS50YXJnZXQuZGF0YXNldC5jdXJyZW50KSlcbiAgICBfdGhpcy5zZXREYXRhISgge1xuICAgICAgY3VycmVudFRhYjogZS50YXJnZXQuZGF0YXNldC5jdXJyZW50XG4gICAgfSlcbiAgfSxcbiAgcmVxdWVzdFBheShwcmVwYXlJZDogbnVtYmVyLG91dFRyYWRlTm86IGFueSx0aXRsZTogc3RyaW5nLCBwcmljZTogYW55LCBjb3Vyc2VpZDogbnVtYmVyKTogdm9pZCB7XG4gICAgcmVxdWVzdCh7XG4gICAgICB1cmw6IEFQSS5zZW5kVGVtcGxhdGUsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIHVzZXJJZDogYXBwLmdsb2JhbERhdGEudXNlckluZm8uaWQsXG4gICAgICAgIHByZXBheUlkOiBwcmVwYXlJZCxcbiAgICAgICAgb3V0VHJhZGVObzogb3V0VHJhZGVObyxcbiAgICAgICAgY291cnNlTmFtZTogdGl0bGUsXG4gICAgICAgIHByaWNlOiBwcmljZSxcbiAgICAgICAgY291cnNlSWQ6IGNvdXJzZWlkLFxuICAgICAgfVxuICAgIH0pLnRoZW4oKHJlczogYW55KT0+e1xuICAgICAgY29uc29sZS5sb2cocmVzKVxuICAgIH0pXG4gIH0sXG59KVxuIl19